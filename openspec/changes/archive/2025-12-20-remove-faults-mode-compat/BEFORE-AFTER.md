# FaultEvent Structure: Before and After

## What We Actually Receive from kubernetes-mcp-server

```json
{
  "subscriptionId": "sub-0ddc180f",
  "cluster": "kind-events-test",
  "resource": {
    "apiVersion": "v1",
    "kind": "Pod",
    "name": "crash-test-pod",
    "namespace": "default"
  },
  "faultType": "CrashLoop",
  "severity": "critical",
  "context": "Container entered CrashLoopBackOff state...",
  "timestamp": "2025-12-19T22:11:10+01:00"
}
```

**Note**: No `event` or `logs` fields - those were from the deprecated "faults" mode.

---

## BEFORE: Current Structure (with backwards compatibility)

```go
// FaultEvent represents a fault event received from kubernetes-mcp-server
// Supports BOTH subscription modes:
// - "faults" mode: uses nested Event struct with InvolvedObject
// - "resource-faults" mode: uses flat Resource struct with context/faultType/severity
type FaultEvent struct {
    EventID        string         `json:"eventId,omitempty"`        // UUID generated on receipt
    ReceivedAt     time.Time      `json:"-"`                        // Time event was received (not serialized)
    SubscriptionID string         `json:"subscriptionId"`
    Cluster        string         `json:"cluster"`
    Event          *EventData     `json:"event,omitempty"`          // Used by "faults" mode (pointer so omitempty works)
    Logs           []ContainerLog `json:"logs,omitempty"`           // Used by "faults" mode
    Resource       *ResourceInfo  `json:"resource,omitempty"`       // Used by "resource-faults" mode
    Context        string         `json:"context,omitempty"`        // Used by "resource-faults" mode
    FaultType      string         `json:"faultType,omitempty"`      // Used by "resource-faults" mode
    Severity       string         `json:"severity,omitempty"`       // Used by "resource-faults" mode
    Timestamp      string         `json:"timestamp,omitempty"`      // Used by "resource-faults" mode
}

// ResourceInfo represents the Kubernetes resource in resource-faults mode
type ResourceInfo struct {
    APIVersion string `json:"apiVersion"`
    Kind       string `json:"kind"`
    Name       string `json:"name"`
    Namespace  string `json:"namespace,omitempty"`
}

// EventData contains the core event information (faults mode)
type EventData struct {
    Namespace      string            `json:"namespace"`
    Timestamp      string            `json:"timestamp"`
    Type           string            `json:"type"`
    Reason         string            `json:"reason"`
    Message        string            `json:"message"`
    Labels         map[string]string `json:"labels,omitempty"`
    InvolvedObject *InvolvedObject   `json:"involvedObject"`
    Count          int32             `json:"count"`
}

// InvolvedObject represents the Kubernetes object involved in the event (faults mode)
type InvolvedObject struct {
    APIVersion string `json:"apiVersion"`
    Kind       string `json:"kind"`
    Name       string `json:"name"`
    Namespace  string `json:"namespace,omitempty"`
    UID        string `json:"uid,omitempty"`
}

// ContainerLog represents captured container logs
type ContainerLog struct {
    ContainerName string `json:"containerName"`
    Log           string `json:"log"`
    HasPanic      bool   `json:"hasPanic,omitempty"`
}
```

### Helper Methods (BEFORE) - with fallback logic

```go
// GetResourceName returns the involved object name
func (f *FaultEvent) GetResourceName() string {
    // Check resource-faults mode first (flat structure)
    if f.Resource != nil && f.Resource.Name != "" {
        return f.Resource.Name
    }
    // Fall back to faults mode (nested structure)
    if f.Event != nil && f.Event.InvolvedObject != nil {
        return f.Event.InvolvedObject.Name
    }
    return ""
}

// ... similar fallback logic in 7 other helper methods ...

// IsResourceFaultsMode returns true if this event came from resource-faults subscription
func (f *FaultEvent) IsResourceFaultsMode() bool {
    return f.Resource != nil
}
```

**Lines of code**: ~173 lines
**Type definitions**: 5 types (FaultEvent, ResourceInfo, EventData, InvolvedObject, ContainerLog)
**Unused code**: Event, Logs, EventData, InvolvedObject, ContainerLog - never populated

---

## AFTER: Simplified Structure (single mode)

```go
// FaultEvent represents a fault event received from kubernetes-mcp-server
type FaultEvent struct {
    // Generated by nightcrier on receipt
    FaultID        string    `json:"faultId,omitempty"`        // UUID for tracing the raw fault notification
    ReceivedAt     time.Time `json:"-"`                        // Time fault was received (not serialized)

    // From kubernetes-mcp-server
    SubscriptionID string        `json:"subscriptionId"`
    Cluster        string        `json:"cluster"`
    Resource       *ResourceInfo `json:"resource"`
    FaultType      string        `json:"faultType"`
    Severity       string        `json:"severity"`
    Context        string        `json:"context"`             // Human-readable fault description
    Timestamp      string        `json:"timestamp"`           // When fault occurred in K8s
}

// ResourceInfo represents the Kubernetes resource involved in the fault
type ResourceInfo struct {
    APIVersion string `json:"apiVersion"`
    Kind       string `json:"kind"`
    Name       string `json:"name"`
    Namespace  string `json:"namespace,omitempty"`
}
```

### Helper Methods (AFTER) - simplified

```go
// GetResourceName returns the resource name
func (f *FaultEvent) GetResourceName() string {
    if f.Resource != nil {
        return f.Resource.Name
    }
    return ""
}

// ... similar simple implementations for 7 other helpers ...

// IsResourceFaultsMode() - DELETED (only one mode exists)
```

**Lines of code**: ~80 lines (54% reduction)
**Type definitions**: 2 types (FaultEvent, ResourceInfo)
**Unused code**: None

---

## Key Changes Summary

### Removed (unused backwards compatibility)
- ❌ `Event *EventData` field and entire EventData type tree
- ❌ `Logs []ContainerLog` field and ContainerLog type
- ❌ InvolvedObject type
- ❌ `IsResourceFaultsMode()` method
- ❌ All fallback logic in helper methods (`if f.Event != nil`)
- ❌ Dual-mode comments and documentation

### Renamed (improved clarity)
- ✏️ `EventID` → `FaultID` (we only handle faults, not general events)
- ✏️ `eventId` → `faultId` (JSON tag)

### Kept (actual functionality)
- ✅ All resource-faults mode fields
- ✅ ResourceInfo type
- ✅ All helper methods (simplified to single code path)
- ✅ DeduplicationKey() method

### Context Field
- The old `Logs []ContainerLog` field from "faults" mode is replaced by `Context string` in resource-faults mode
- `Context` provides a human-readable description of the fault
- kubernetes-mcp-server does the log aggregation/summarization upstream

---

## Impact

### Breaking Changes
- ⚠️ FaultEvent JSON serialization changes: `eventId` → `faultId`
- ⚠️ Code referencing `event.EventID` must change to `event.FaultID`
- ⚠️ Will not work with kubernetes-mcp-server versions that only support "faults" mode

### Benefits
- ✅ 54% reduction in code (173 → 80 lines)
- ✅ No unused code paths
- ✅ Clearer naming (FaultID vs EventID)
- ✅ Reduced cognitive load
- ✅ Single responsibility (fault handling only)
- ✅ Easier to maintain and understand
