# Design Document: Fix HTML Report Formatting Issues

## Context

The system generates incident investigation reports in three formats:
1. **investigation.md** - Markdown source (AI-generated)
2. **investigation.html** - HTML version for browser viewing (converted from markdown)
3. **incident.json** - Structured data

The HTML conversion uses the `gomarkdown/markdown` library with standard CommonMark extensions. The issue is that certain markdown patterns generated by the AI agent don't render correctly in HTML, specifically missing line breaks in metadata sections.

## Technical Analysis

### Current Flow
```
Agent generates investigation.md
    ↓
readIncidentArtifacts() reads the file
    ↓
reporting.ConvertMarkdownToHTML() converts to HTML
    ↓
storage.SaveIncident() saves both .md and .html
```

### Root Cause Details

The markdown parser follows CommonMark spec, which states:
- Single newline = soft line break (ignored in HTML, rendered as space)
- Double newline = paragraph break (`<p>` tag)
- Line ending with two spaces + newline = hard line break (`<br>` tag)

When the agent generates:
```markdown
**Incident ID**: 51bc93d9-6c96-4f15-bae0-c633d391a6d7
**Cluster**: kind-events-test
**Namespace**: default
```

The parser sees this as a single paragraph and renders:
```html
<p><strong>Incident ID</strong>: 51bc... <strong>Cluster</strong>: kind... <strong>Namespace</strong>: default</p>
```

### Solution Design

We'll implement a **hybrid approach** combining preprocessing and prompt guidance.

#### Component 1: Markdown Preprocessor

Add a preprocessing function in `internal/reporting/markdown.go`:

```go
// preprocessMarkdown normalizes markdown for better HTML rendering
func preprocessMarkdown(content []byte) []byte {
    lines := bytes.Split(content, []byte("\n"))
    var result [][]byte

    for i, line := range lines {
        // Detect metadata pattern: **Label**: value
        if bytes.HasPrefix(bytes.TrimSpace(line), []byte("**")) &&
           bytes.Contains(line, []byte("**:")) {
            // Add double-space line ending if not already present
            trimmed := bytes.TrimRight(line, " \t\r\n")
            if !bytes.HasSuffix(trimmed, []byte("  ")) {
                trimmed = append(trimmed, []byte("  ")...)
            }
            result = append(result, trimmed)
        } else {
            result = append(result, line)
        }
    }

    return bytes.Join(result, []byte("\n"))
}
```

**Detection Logic:**
1. Line starts with `**` (after trimming whitespace)
2. Line contains `**:` pattern (indicates `**Label**:`)
3. Add two-space suffix if not present
4. Preserve all other lines unchanged

**Edge Cases Handled:**
- Lines already ending with double-space (idempotent)
- Inline code blocks within metadata (preserved)
- False positives (e.g., bold text mid-paragraph) - minimal impact, extra `<br>` acceptable
- Multi-line metadata values - only first line gets `<br>`, which is correct

#### Component 2: Agent Prompt Enhancement

Update the agent prompt in `internal/config/config.go`:

```go
viper.SetDefault("agent_prompt", `Production incident detected. Incident context is in incident.json.

Perform immediate triage and root cause analysis. Write findings to output/investigation.md

FORMATTING REQUIREMENTS:
- Use double newlines between major sections
- For metadata fields (e.g., **Cluster**: value), use double newlines OR end lines with double-space for proper HTML rendering
- Use proper markdown syntax for code blocks, lists, and tables`)
```

**Rationale:**
- Explicit guidance for AI about markdown formatting
- Defensive: Even if AI doesn't follow perfectly, preprocessor catches it
- Doesn't overcomplicate prompt with technical details

#### Component 3: CSS Enhancements

Add CSS rules for better spacing and readability:

```css
/* Ensure paragraphs in the report body have breathing room */
p {
    margin: 10px 0;
}

/* Metadata sections with bold labels */
p strong:first-child {
    display: inline-block;
    min-width: 120px;
}

/* Line breaks should be visible */
br {
    content: "";
    display: block;
    margin: 4px 0;
}
```

**Rationale:**
- Provides visual separation even if markdown formatting isn't perfect
- Makes bold labels more scannable
- Defensive: Improves rendering regardless of markdown structure

## Implementation Strategy

### Phase 1: Test-Driven Development
1. Write tests first to capture expected behavior
2. Test various markdown patterns:
   - Metadata with `**Label**:` format
   - Inline code within metadata
   - Code blocks (should not be modified)
   - Regular paragraphs (should not be modified)
3. Verify tests fail with current code

### Phase 2: Implement Preprocessor
1. Add `preprocessMarkdown()` function
2. Call it in `ConvertMarkdownToHTML()` before parsing
3. Run tests to verify fix

### Phase 3: Enhance Prompt
1. Update default agent prompt
2. Test with live agent invocation
3. Verify output quality

### Phase 4: CSS Polish
1. Add CSS enhancements
2. Test visual appearance in browser

## Testing Strategy

### Unit Tests
```go
func TestPreprocessMarkdown(t *testing.T) {
    tests := []struct {
        name     string
        input    string
        expected string
    }{
        {
            name: "metadata fields get line breaks",
            input: "**Cluster**: test\n**Namespace**: default",
            expected: "**Cluster**: test  \n**Namespace**: default  ",
        },
        {
            name: "code blocks unchanged",
            input: "```\n**not**: metadata\n```",
            expected: "```\n**not**: metadata\n```",
        },
        // More test cases...
    }
    // Test implementation...
}
```

### Integration Tests
1. Generate full HTML from test markdown
2. Parse HTML with `golang.org/x/net/html` parser
3. Verify `<br>` tags exist where expected
4. Verify no regressions in other sections

### Manual Testing
1. Run agent against test cluster
2. View generated HTML in browser
3. Verify visual appearance matches expectations

## Performance Considerations

**Impact Analysis:**
- Preprocessing adds one pass through markdown content
- Content size: typically 5-20 KB per report
- Processing time: < 1ms on modern hardware
- Memory overhead: temporary copy of content (negligible)

**Optimization:**
- Use `bytes` package to avoid string allocations
- Single-pass algorithm (no backtracking)
- In-place modifications where possible

## Backward Compatibility

**Existing Reports:**
- Already generated HTML files are not affected (static)
- Already generated markdown files will be reprocessed correctly if re-converted
- No migration needed

**API Compatibility:**
- No changes to function signatures
- No changes to storage schema
- No changes to Slack notifications

## Risks and Mitigations

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Preprocessor breaks valid markdown | Low | Medium | Comprehensive test suite covering edge cases |
| Performance degradation | Very Low | Low | Benchmark tests; content size is small |
| AI ignores prompt instructions | Medium | Low | Preprocessor acts as safety net |
| CSS changes affect mobile viewing | Low | Low | Test on multiple screen sizes |

## Rollback Strategy

If issues are discovered after deployment:
1. Revert commit containing preprocessor changes
2. Keep prompt and CSS changes (low risk)
3. System returns to current behavior (suboptimal but functional)
4. No data loss or corruption possible

## Future Improvements

Potential enhancements for future iterations:
1. **Structured metadata block**: Generate HTML table for metadata instead of paragraph
2. **Custom markdown extension**: Add syntax for metadata blocks (e.g., `:::metadata`)
3. **Template-based generation**: Move from AI-generated markdown to structured templates
4. **Client-side rendering**: Use JavaScript to format metadata dynamically

These are NOT in scope for this change but could be considered later if needed.

## References

- [CommonMark Specification](https://spec.commonmark.org/0.30/)
- [gomarkdown library](https://github.com/gomarkdown/markdown)
- [Example problematic report](https://nightcrierincidents.blob.core.windows.net/incident-reports/51bc93d9-6c96-4f15-bae0-c633d391a6d7%2Finvestigation.html)
