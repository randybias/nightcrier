# Nightcrier Configuration
# Copy this file to config.yaml and customize as needed.
#
# Configuration Precedence (highest to lowest):
# 1. Command-line flags (e.g., --mcp-endpoint)
# 2. Environment variables (e.g., K8S_CLUSTER_MCP_ENDPOINT)
# 3. This configuration file
#
# IMPORTANT: All fields marked as "Required" MUST be provided through one of these sources.
# There are no default values for required fields.
#
# Nightcrier searches for config.yaml in:
# - Current directory (.)
# - ./configs/
# - /etc/nightcrier/
# Or specify explicitly with: nightcrier --config /path/to/config.yaml

# =============================================================================
# Cluster Configuration (Required)
# =============================================================================
# REQUIRED: Array of clusters to monitor. Each cluster has its own MCP server
# endpoint and optional triage configuration.
clusters:
  - name: prod-us-east-1
    environment: production

    # MCP server connection settings
    mcp:
      endpoint: "http://kubernetes-mcp-server:8080/mcp"
      # API key placeholder for future MCP server authentication
      api_key: "THIS_IS_A_PLACEHOLDER_TO_REMIND_US_TO_MAKE_AUTH_WORK_ON_THE_MCP_SERVER"

    # Triage agent configuration
    triage:
      enabled: true
      kubeconfig: "./kubeconfigs/prod-us-east-1-readonly.yaml"
      # Allow agent to read secrets/configmaps for Helm debugging
      # Default: false (disabled for security - secrets may contain credentials)
      # When enabled, agent can run helm_release_debug.sh and access Helm release data
      allow_secrets_access: false

# REQUIRED: Subscription mode for events_subscribe tool: "events" or "faults"
# - "faults": Only receive fault/warning events (recommended)
# - "events": Receive all Kubernetes events
# Environment variable: SUBSCRIBE_MODE
subscribe_mode: "faults"

# =============================================================================
# Workspace Configuration (Required)
# =============================================================================
# REQUIRED: Directory where incident workspaces are created
# Each incident gets a unique subdirectory with event context and results
# Environment variable: WORKSPACE_ROOT
workspace_root: "./incidents"

# =============================================================================
# Logging (Optional)
# =============================================================================
# Log level: debug, info, warn, error
# Default: info
# Environment variable: LOG_LEVEL
log_level: "info"

# =============================================================================
# Agent Configuration (Required)
# =============================================================================
# REQUIRED: Path to the agent execution script
# Environment variable: AGENT_SCRIPT_PATH
agent_script_path: "./agent-container/run-agent.sh"

# Optional: Path to the system prompt file for the agent
# Environment variable: AGENT_SYSTEM_PROMPT_FILE
agent_system_prompt_file: "./configs/triage-system-prompt.md"

# Optional: Comma-separated list of tools the agent is allowed to use
# Default: Read,Write,Grep,Glob,Bash,Skill
# Environment variable: AGENT_ALLOWED_TOOLS
agent_allowed_tools: "Read,Write,Grep,Glob,Bash,Skill"

# REQUIRED: AI model to use: sonnet, opus, haiku (Claude models)
# Environment variable: AGENT_MODEL
agent_model: "sonnet"

# REQUIRED: Maximum execution time for agent in seconds
# Environment variable: AGENT_TIMEOUT
agent_timeout: 300

# REQUIRED: AI CLI to use: claude, codex, goose, gemini
# Environment variable: AGENT_CLI
agent_cli: "claude"

# REQUIRED: Docker image for the agent container
# Environment variable: AGENT_IMAGE
agent_image: "nightcrier-agent:latest"

# REQUIRED: Prompt sent to the agent for triage
# This can be customized to change how the agent approaches incidents
# Environment variable: AGENT_PROMPT
agent_prompt: "Production incident detected. Incident context is in incident.json. Review incident_cluster_permissions.json to understand your cluster access constraints. Perform immediate triage and root cause analysis. Write findings to output/investigation.md"

# =============================================================================
# LLM API Keys (At least one required)
# =============================================================================
# REQUIRED: At least one LLM API key must be provided.
# These can also be set via environment variables.
# Only set the key(s) for the LLM provider(s) you're using.
# WARNING: Be careful not to commit API keys to version control!
#
# Anthropic API key (for Claude)
# Environment variable: ANTHROPIC_API_KEY
# anthropic_api_key: "sk-ant-..."
#
# OpenAI API key (for Codex/GPT)
# Environment variable: OPENAI_API_KEY
# openai_api_key: "sk-..."
#
# Google/Gemini API key
# Environment variable: GEMINI_API_KEY
# gemini_api_key: "..."

# =============================================================================
# Kubernetes Configuration
# =============================================================================
# Path to kubeconfig file
# Environment variable: KUBECONFIG_PATH
# kubeconfig_path: "~/.kube/config"

# Kubernetes context to use (default: current context)
# Environment variable: KUBERNETES_CONTEXT
# kubernetes_context: "my-cluster"

# =============================================================================
# Event Processing (Required)
# =============================================================================
# REQUIRED: Minimum severity level to process: DEBUG, INFO, WARNING, ERROR, CRITICAL
# Events below this threshold are filtered out
# Environment variable: SEVERITY_THRESHOLD
severity_threshold: "ERROR"

# REQUIRED: Maximum number of concurrent agent sessions across all clusters
# Acts as a global circuit breaker to prevent resource exhaustion
# Environment variable: MAX_CONCURRENT_AGENTS
max_concurrent_agents: 5

# REQUIRED: Maximum size of the global event queue
# Environment variable: GLOBAL_QUEUE_SIZE
global_queue_size: 100

# REQUIRED: Maximum size of per-cluster event queues
# Each cluster gets its own queue to ensure fair processing
# Environment variable: CLUSTER_QUEUE_SIZE
cluster_queue_size: 10

# REQUIRED: Deduplication window in seconds (set to 0 to disable)
# Events for the same resource within this window are deduplicated
# Environment variable: DEDUP_WINDOW_SECONDS
dedup_window_seconds: 300

# REQUIRED: Queue overflow policy: drop (remove oldest) or reject (reject new events)
# Environment variable: QUEUE_OVERFLOW_POLICY
queue_overflow_policy: "drop"

# REQUIRED: Graceful shutdown timeout in seconds
# Environment variable: SHUTDOWN_TIMEOUT_SECONDS
shutdown_timeout: 30

# =============================================================================
# SSE/MCP Reconnection Settings (Required)
# =============================================================================
# REQUIRED: Initial backoff delay for reconnection attempts (seconds)
# Environment variable: SSE_RECONNECT_INITIAL_BACKOFF
sse_reconnect_initial_backoff: 1

# REQUIRED: Maximum backoff delay for reconnection attempts (seconds)
# Environment variable: SSE_RECONNECT_MAX_BACKOFF
sse_reconnect_max_backoff: 60

# REQUIRED: Read timeout for SSE/MCP connections (seconds)
# Environment variable: SSE_READ_TIMEOUT_SECONDS
sse_read_timeout: 120

# =============================================================================
# Slack Integration (Optional)
# =============================================================================
# Slack webhook URL for incident notifications
# If not set, Slack notifications are disabled
# Environment variable: SLACK_WEBHOOK_URL
# slack_webhook_url: "https://hooks.slack.com/services/..."

# =============================================================================
# Azure Blob Storage (Optional)
# =============================================================================
# When configured, incident artifacts are uploaded to Azure Blob Storage
# and SAS URLs are included in Slack notifications for direct access.
#
# Authentication: Provide EITHER connection_string OR (account + key)
#
# Full Azure connection string
# Environment variable: AZURE_STORAGE_CONNECTION_STRING
# azure_storage_connection_string: "DefaultEndpointsProtocol=https;AccountName=...;AccountKey=...;EndpointSuffix=core.windows.net"
#
# OR use separate account and key:
# Environment variable: AZURE_STORAGE_ACCOUNT
# azure_storage_account: "mystorageaccount"
# Environment variable: AZURE_STORAGE_KEY
# azure_storage_key: "..."
#
# Blob container name (required if Azure storage is enabled)
# Environment variable: AZURE_STORAGE_CONTAINER
# azure_storage_container: "incidents"
#
# SAS URL expiration duration (Go duration format)
# Environment variable: AZURE_SAS_EXPIRY
# azure_sas_expiry: "168h"  # 7 days

# =============================================================================
# Circuit Breaker and Failure Notifications (Required/Optional)
# =============================================================================
# Optional: Whether to send notifications when agent failures occur
# When true, system degraded alerts are sent after threshold is reached
# Default: true
# Environment variable: NOTIFY_ON_AGENT_FAILURE
notify_on_agent_failure: true

# REQUIRED: Number of consecutive failures before triggering a system degraded alert
# Lower values = more sensitive, higher values = more tolerant
# Environment variable: FAILURE_THRESHOLD_FOR_ALERT
failure_threshold_for_alert: 3

# Optional: Whether to upload failed investigation attempts to storage
# When true, even failed investigations are saved to Azure/filesystem storage
# When false, only successful investigations are uploaded
# Default: false
# Environment variable: UPLOAD_FAILED_INVESTIGATIONS
upload_failed_investigations: false
